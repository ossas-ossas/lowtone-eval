# 部署指南

## 1. 环境准备

### 1.1 微信小程序账号
1. 注册微信小程序账号
2. 获取AppID
3. 开通云开发服务
4. 开通云托管服务

### 1.2 开发工具
1. 下载并安装微信开发者工具
2. 使用微信扫码登录
3. 安装云托管CLI工具

### 1.3 云托管服务
根据[微信云托管](https://express-494j-194862-5-1383882885.sh.run.tcloudbase.com/)的指引，您已经拥有了云托管访问域名。

## 2. 项目配置

### 2.1 导入项目
1. 打开微信开发者工具
2. 选择"导入项目"
3. 选择项目根目录
4. 输入AppID（或使用测试号）

### 2.2 配置云开发
1. 在微信开发者工具中点击"云开发"
2. 开通云开发服务
3. 记录环境ID
4. 在`app.js`中替换环境ID：
```javascript
wx.cloud.init({
  env: 'your-cloud-env-id', // 替换为你的云开发环境ID
  traceUser: true,
})
```

### 2.3 配置项目文件
1. 更新`project.config.json`中的appid
2. 更新`project.private.config.json`中的环境ID

## 3. 云托管部署

### 3.1 安装云托管CLI
```bash
npm install -g @cloudbase/cli
```

### 3.2 登录云托管
```bash
tcb login
```

### 3.3 部署云托管服务
```bash
# 进入云托管目录
cd cloudbase

# 安装依赖
npm install

# 部署到云托管
tcb hosting deploy
```

### 3.4 配置环境变量
在云托管控制台配置以下环境变量：
- `NODE_ENV`: production
- `DB_URL`: 数据库连接字符串
- `STORAGE_BUCKET`: 存储桶名称

## 4. 云函数部署（可选）

如果您选择使用云函数而不是云托管，可以按照以下步骤部署：

### 4.1 安装依赖
在`cloudfunctions`目录下，为每个云函数安装依赖：

```bash
# 进入云函数目录
cd cloudfunctions/getOpenId
npm install

cd ../upsertSubmission
npm install

cd ../getSubmission
npm install

cd ../listSubmissions
npm install

cd ../generateReport
npm install

cd ../seedDictionary
npm install
```

### 4.2 上传云函数
1. 在微信开发者工具中右键点击`cloudfunctions`目录
2. 选择"上传并部署：云端安装依赖"
3. 等待所有云函数部署完成

## 5. 数据库配置

### 5.1 创建集合
在云开发控制台中创建以下集合：
- `dictionary` - 量表字典
- `submissions` - 评估提交
- `users` - 用户信息

### 5.2 设置权限
为每个集合设置适当的权限：
- `dictionary`: 所有用户可读
- `submissions`: 用户只能读写自己的数据
- `users`: 用户只能读写自己的数据

### 5.3 初始化数据
如果使用云托管，通过API初始化数据：
```javascript
// 调用云托管API初始化量表数据
wx.request({
  url: 'https://express-494j-194862-5-1383882885.sh.run.tcloudbase.com/api/dictionary',
  method: 'POST',
  data: dictionaryData,
  success: res => {
    console.log('量表数据初始化成功', res);
  }
});
```

如果使用云函数，调用云函数初始化：
```javascript
wx.cloud.callFunction({
  name: 'seedDictionary',
  success: res => {
    console.log('量表数据初始化成功', res);
  }
});
```

## 6. 云存储配置

### 6.1 创建存储桶
在云开发控制台中创建存储桶用于存放报告文件。

### 6.2 设置权限
设置存储桶的读写权限，确保云函数可以上传文件。

## 7. 测试部署

### 7.1 本地测试
1. 在微信开发者工具中点击"编译"
2. 检查是否有编译错误
3. 在模拟器中测试基本功能

### 7.2 真机测试
1. 点击"预览"生成二维码
2. 使用微信扫码在真机上测试
3. 测试完整流程：登录→填表→提交→查看结果

### 7.3 功能测试清单
- [ ] 微信登录功能
- [ ] 量表填写功能
- [ ] 数据提交功能（云托管API）
- [ ] 图表显示功能
- [ ] 报告生成功能
- [ ] 历史记录查看
- [ ] 管理后台功能

## 8. 发布上线

### 8.1 代码审核
1. 确保代码质量
2. 检查敏感信息
3. 测试所有功能

### 8.2 提交审核
1. 在微信开发者工具中点击"上传"
2. 填写版本信息和更新说明
3. 提交审核

### 8.3 发布版本
1. 审核通过后，在微信公众平台发布
2. 设置版本信息
3. 通知用户更新

## 9. 运维监控

### 9.1 性能监控
- 监控云托管API调用次数
- 监控数据库读写性能
- 监控存储使用情况

### 9.2 错误监控
- 设置云托管错误告警
- 监控用户反馈
- 定期检查日志

### 9.3 数据备份
- 定期备份数据库
- 备份重要文件
- 制定灾难恢复计划

## 10. 常见问题

### 10.1 云托管API调用失败
- 检查云托管服务是否正确部署
- 检查API地址配置
- 查看云托管日志

### 10.2 数据库连接失败
- 检查环境ID配置
- 检查数据库权限
- 检查网络连接

### 10.3 图表显示异常
- 检查ECharts组件配置
- 检查数据格式
- 检查Canvas权限

### 10.4 云托管部署失败
- 检查依赖安装
- 检查环境变量配置
- 查看部署日志

## 11. 联系方式

如有部署问题，请联系开发团队获取技术支持。

## 12. 云托管优势

使用[微信云托管](https://express-494j-194862-5-1383882885.sh.run.tcloudbase.com/)的优势：

1. **更好的性能**：相比云函数，云托管提供更稳定的运行环境
2. **更灵活的配置**：支持自定义环境变量和配置
3. **更好的监控**：提供详细的性能监控和日志
4. **更低的成本**：按实际使用量计费，成本更低
5. **更好的扩展性**：支持自动扩缩容
